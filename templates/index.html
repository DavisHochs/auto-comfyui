<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ComfyUI Prompt Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light full-height d-flex align-items-start">

  <div class="container-fluid py-4 full-height">
    <div class="row h-100">

      <!-- History sidebar -->
      <div class="col-12 col-md-4 col-lg-3 mb-4 mb-md-0" id="history-col">
        <h5 class="mb-3">Prompt History</h5>
        <ul class="list-group" id="historyList">
          <li class="list-group-item text-muted">No prompts queued yet</li>
        </ul>
      </div>

      <!-- Main content -->
      <div class="col-12 col-md-8 col-lg-9">

        <!-- Queue status banner -->
        <div id="queueInfo" class="alert alert-info text-center mb-4" role="alert">
          Queue: <strong><span id="queueCount">–</span></strong>
          (<span id="queueRunning">–</span> running, <span id="queuePending">–</span> pending)
        </div>

        <div class="card shadow-sm p-4">
          <h2 class="card-title text-center mb-4">ComfyUI Prompt Builder</h2>
          <a href="/gallery" class="btn btn-outline-secondary mb-3">
            View Saved Images
          </a>

          <!-- LOCKED-DOWN FORM -->
          <form id="promptForm">
            <div class="mb-3">
              <label for="prompt" class="form-label">Prompt</label>
              <textarea
                class="form-control"
                id="prompt"
                name="prompt"
                rows="6"
                required
              ></textarea>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">
                Generate
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let history = [];
    let pollIntervalID = null;

    // Load and render the prompt history
    async function loadHistory() {
      try {
        const res = await fetch("/history");
        history = await res.json();
        renderHistory();
      } catch (err) {
        console.error("Failed to load history:", err);
      }
    }

    function renderHistory() {
      const ul = document.getElementById("historyList");
      ul.innerHTML = "";
      if (history.length === 0) {
        ul.innerHTML = '<li class="list-group-item text-muted">No prompts queued yet</li>';
        return;
      }
      history.forEach(entry => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `
          <div class="d-flex justify-content-between">
            <small class="text-muted">${new Date(entry.time).toLocaleTimeString()}</small>
          </div>
          <div class="mt-1"><strong>Prompt:</strong> ${entry.prompt.slice(0,50)}…</div>
        `;
        ul.insertBefore(li, ul.firstChild);
      });
    }

    // Poll the queue status every 15s
    async function updateQueueStatus() {
      try {
        const res = await fetch("/queue_status");
        const data = await res.json();
        const running = Array.isArray(data.queue_running) ? data.queue_running.length : 0;
        const pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : 0;
        document.getElementById("queueCount").innerText   = running + pending;
        document.getElementById("queueRunning").innerText = running;
        document.getElementById("queuePending").innerText = pending;
      } catch (err) {
        console.error("Queue status error:", err);
      }
    }

    function startPolling() {
      if (pollIntervalID === null) {
        updateQueueStatus();
        pollIntervalID = setInterval(updateQueueStatus, 15000);
      }
    }

    // Send just the prompt; backend will apply your hard-coded defaults
    async function queuePrompt(prompt) {
      try {
        const res = await fetch("/generate_image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Unknown error");
        alert("✅ Job queued!");
        await loadHistory();
        startPolling();
      } catch (err) {
        alert("❌ Failed to queue: " + err.message);
      }
    }

    // Hook up the single-field form
    document.getElementById("promptForm").addEventListener("submit", e => {
      e.preventDefault();
      const txt = document.getElementById("prompt").value.trim();
      if (!txt) return alert("Please enter a prompt.");
      queuePrompt(txt);
    });

    // Initialize on page load
    startPolling();
    loadHistory();
  </script>
</body>
</html>
